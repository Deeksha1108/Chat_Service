<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Private Chat (1-to-1) UI</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  </head>
  <body style="font-family: sans-serif; padding: 20px">
    <h2>💬 Private Chat (1-to-1)</h2>

    <label>Your User ID: </label>
    <input type="text" id="userIdInput" placeholder="Enter your userId" />
    <button onclick="generateUserId()">Random ID</button>
    <button onclick="connect()">Join Chat</button>

    <hr />

    <div id="chatUI" style="display: none">
      <label>Send to User ID: </label>
      <input
        type="text"
        id="receiverIdInput"
        placeholder="Enter receiver userId"
      /><br /><br />

      <label>Message: </label>
      <input type="text" id="messageInput" placeholder="Enter your message" />
      <button onclick="sendMessage()">Send</button>

      <hr />
      <div>
        <h4>Messages</h4>
        <div
          id="messages"
          style="
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            background: #f9f9f9;
          "
        ></div>
      </div>
    </div>

    <script>
      let socket;
      let userId;

      function generateUserId() {
        const hex = [...Array(24)]
          .map(() => Math.floor(Math.random() * 16).toString(16))
          .join('');
        document.getElementById('userIdInput').value = hex;
      }

      function connect() {
        userId = document.getElementById('userIdInput').value;
        if (!userId) return alert('Please enter userId first.');

        socket = io('http://localhost:3000/chat', {
          query: { userId },
          transports: ['websocket'],
        });

        socket.on('connect', () => {
          logMessage(`✅ Connected as ${userId}`, false, true);
          document.getElementById('chatUI').style.display = 'block';
        });

        socket.on('receiveMessage', (msg) => {
          const isSender = msg.sender === userId;
          logMessage(`${msg.content}`, isSender, false, msg._id);

          if (!isSender) {
            socket.emit('messageDelivered', { messageId: msg._id });
            socket.emit('readMessage', { messageId: msg._id });
          }
        });

        socket.on('messageSent', (res) => {
          if (res.status === 'success') {
            logMessage(`${res.message.content}`, true, false, res.message._id);
          } else {
            logMessage('❌ Message send failed.', false);
          }
        });

        socket.on('messageDeliveryAck', (data) => {
          console.log(`📬 Message ${data.messageId} marked as delivered`);
        });

        socket.on('messageReadAck', (data) => {
          console.log(`✅ Message ${data.messageId} marked as read`);

          const msgDiv = document.querySelector(
            `[data-id="${data.messageId}"]`,
          );
          if (msgDiv) {
            const tick = msgDiv.querySelector('.tick');
            if (tick) {
              tick.style.color = '#007bff'; // blue tick
            }
          }
        });

        socket.on('disconnect', () => {
          logMessage('❌ Disconnected', false, true);
        });

        socket.io.on('reconnect_attempt', () => {
          console.log('Attempting to reconnect...');
        });
      }

      function sendMessage() {
        const receiverId = document.getElementById('receiverIdInput').value;
        const content = document.getElementById('messageInput').value;
        if (!receiverId || !content) {
          return alert('Please fill both receiver ID and message');
        }

        socket.emit('sendMessage', { receiverId, content });
        document.getElementById('messageInput').value = '';
      }

      function logMessage(
        msg,
        isSender = false,
        isSystem = false,
        messageId = '',
      ) {
        const div = document.createElement('div');
        div.textContent = msg;
        div.style.padding = '8px 12px';
        div.style.margin = '6px 0';
        div.style.borderRadius = '18px';
        div.style.maxWidth = '60%';
        div.style.wordWrap = 'break-word';
        div.style.fontSize = '15px';
        div.style.position = 'relative';

        if (messageId) div.setAttribute('data-id', messageId);

        if (isSystem) {
          div.style.backgroundColor = '#e0e0e0';
          div.style.textAlign = 'center';
          div.style.color = '#333';
          div.style.margin = '8px auto';
        } else if (isSender) {
          div.style.backgroundColor = '#DCF8C6';
          div.style.marginLeft = 'auto';
          div.style.textAlign = 'right';

          const tickSpan = document.createElement('span');
          tickSpan.className = 'tick';
          tickSpan.style.fontSize = '14px';
          tickSpan.style.color = 'gray';
          tickSpan.innerText = ' ✔✔'; // Default gray tick
          div.appendChild(tickSpan);
        } else {
          div.style.backgroundColor = '#FFFFFF';
          div.style.marginRight = 'auto';
          div.style.textAlign = 'left';
        }

        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop =
          document.getElementById('messages').scrollHeight;
      }
    </script>
  </body>
</html>
